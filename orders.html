<!DOCTYPE html>
<html lang="en">

<head>
    <link rel="icon" type="image/png" href="assets/favicon.png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MODA IMPETO | 注文管理</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Bodoni+Moda:wght@400;700&family=Cinzel:wght@400;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="admin.css">
    <style>
        .admin-container {
            padding: 100px 20px;
            max-width: 1000px;
            margin: 0 auto;
        }

        .header-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 40px;
        }

        .order-card {
            background: var(--color-black-light);
            border: 1px solid var(--color-gray-dark);
            margin-bottom: 20px;
            padding: 20px;
        }

        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }

        .order-details {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--color-gray-dark);
            display: none;
        }

        .order-details.active {
            display: block;
        }

        .detail-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .status-badge {
            padding: 5px 10px;
            font-size: 12px;
            border-radius: 4px;
        }

        .status-processing {
            background: #ffd700;
            color: #000;
        }

        .status-shipped {
            background: #00ff00;
            color: #000;
        }

        .product-summary {
            margin-top: 10px;
            background: #000;
            padding: 10px;
        }

        .item-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 14px;
        }

        .status-select {
            background: #000;
            color: #fff;
            border: 1px solid var(--color-gray-dark);
            padding: 5px 10px;
            font-family: inherit;
            cursor: pointer;
            outline: none;
            margin-top: 5px;
        }

        .status-select:focus {
            border-color: var(--color-red);
        }

        .status-tab {
            background: transparent;
            border: 1px solid var(--color-gray-dark);
            color: var(--color-gray);
            padding: 8px 16px;
            font-family: inherit;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .status-tab:hover {
            border-color: var(--color-white);
            color: var(--color-white);
        }

        .status-tab.active {
            background: var(--color-white);
            color: var(--color-black);
            border-color: var(--color-white);
        }

        .status-section {
            margin-bottom: 40px;
        }

        .status-section-title {
            font-size: 18px;
            color: var(--color-gray);
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--color-gray-dark);
        }

        .order-count {
            font-size: 12px;
            background: var(--color-gray-dark);
            padding: 2px 8px;
            border-radius: 10px;
            margin-left: 10px;
        }

        .status-pending {
            background: #888;
            color: #fff;
        }

        .status-cancelled {
            background: #ff4444;
            color: #fff;
        }

        .order-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .order-item:last-child {
            border-bottom: none;
        }

        .order-item-image {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            flex-shrink: 0;
        }

        .order-item-details {
            flex: 1;
        }

        .order-item-name {
            font-weight: 500;
            color: #fff;
            margin-bottom: 4px;
        }

        .order-item-meta {
            font-size: 0.85rem;
            color: var(--color-gray);
        }

        .order-item-price {
            font-weight: 600;
            white-space: nowrap;
        }
    </style>
</head>

<body>
    <div class="admin-layout">
        <!-- Sidebar -->
        <aside class="admin-sidebar">
            <div class="admin-sidebar__logo">
                <a href="index.html"><img src="assets/logo.png" alt="MODA IMPETO"></a>
            </div>
            <nav class="admin-sidebar__nav">
                <a href="admin.html" class="admin-sidebar__link">
                    <svg viewBox="0 0 24 24">
                        <path
                            d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 3c1.93 0 3.5 1.57 3.5 3.5S13.93 13 12 13s-3.5-1.57-3.5-3.5S10.07 6 12 6zm7 13H5v-.23c0-.62.28-1.2.76-1.58C7.47 15.82 9.64 15 12 15s4.53.82 6.24 2.19c.48.38.76.97.76 1.58V19z" />
                    </svg>
                    商品管理
                </a>
                <a href="orders.html" class="admin-sidebar__link active">
                    <svg viewBox="0 0 24 24">
                        <path
                            d="M18 17H6v-2h12v2zm0-4H6v-2h12v2zm0-4H6V7h12v2zM3 22l1.5-1.5L6 22l1.5-1.5L9 22l1.5-1.5L12 22l1.5-1.5L15 22l1.5-1.5L18 22l1.5-1.5L21 22V2l-1.5 1.5L18 2l-1.5 1.5L15 2l-1.5 1.5L12 2l-1.5 1.5L9 2 7.5 3.5 6 2 4.5 3.5 3 2v20z" />
                    </svg>
                    注文管理
                </a>
                <a href="inventory.html" class="admin-sidebar__link">
                    <svg viewBox="0 0 24 24">
                        <path
                            d="M20 2H4c-1 0-2 .9-2 2v3.01c0 .72.43 1.34 1 1.69V20c0 1.1 1.1 2 2 2h14c.9 0 2-.9 2-2V8.7c.57-.35 1-.97 1-1.69V4c0-1.1-1-2-2-2zm-5 12H9v-2h6v2zm5-7H4V4h16v3z" />
                    </svg>
                    在庫管理
                </a>
                <a href="admin_users.html" class="admin-sidebar__link">
                    <svg viewBox="0 0 24 24">
                        <path
                            d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z" />
                    </svg>
                    顧客管理
                </a>
            </nav>
            <div class="admin-sidebar__footer">
                <button class="admin-sidebar__logout" id="logoutBtn">ログアウト</button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="admin-main">
            <header class="admin-header">
                <h1 class="admin-header__title">注文管理</h1>
                <p class="admin-header__subtitle">すべての注文を管理します</p>
            </header>

            <!-- Status Filter Tabs -->
            <div class="status-tabs" style="display: flex; gap: 10px; margin-bottom: 30px; flex-wrap: wrap;">
                <button class="status-tab active" data-status="all" onclick="filterByStatus('all')">すべて</button>
                <button class="status-tab" data-status="Processing" onclick="filterByStatus('Processing')">処理中</button>
                <button class="status-tab" data-status="Shipped" onclick="filterByStatus('Shipped')">発送済み</button>
                <button class="status-tab" data-status="Delivered" onclick="filterByStatus('Delivered')">配達完了</button>
                <button class="status-tab" data-status="Pending" onclick="filterByStatus('Pending')">保留中</button>
                <button class="status-tab" data-status="Cancelled" onclick="filterByStatus('Cancelled')">キャンセル</button>
            </div>

            <div id="ordersList">
                <p style="text-align: center; color: var(--color-gray);">注文を読み込み中...</p>
            </div>
        </main>
    </div>

    <script>
        const API_URL = '/api/orders';
        let token = localStorage.getItem('adminToken');

        if (!token) {
            window.location.href = 'login.html';
        }

        async function fetchWithAuth(url, options = {}) {
            const headers = {
                ...options.headers,
                'Authorization': `Bearer ${token}`
            };
            const res = await fetch(url, { ...options, headers });
            if (res.status === 401 || res.status === 403) {
                const refreshed = await refreshToken();
                if (refreshed) {
                    headers['Authorization'] = `Bearer ${token}`;
                    return fetch(url, { ...options, headers });
                } else {
                    alert('セッションが期限切れです。再度ログインしてください。');
                    localStorage.removeItem('adminToken');
                    window.location.href = 'login.html';
                }
            }
            return res;
        }

        async function refreshToken() {
            try {
                const res = await fetch('/api/auth/refresh', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (res.ok) {
                    const data = await res.json();
                    token = data.token;
                    localStorage.setItem('adminToken', token);
                    return true;
                }
                return false;
            } catch (err) {
                return false;
            }
        }

        async function scheduleTokenRefresh() {
            try {
                const res = await fetch('/api/auth/verify', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (res.ok) {
                    const data = await res.json();
                    const refreshIn = Math.min(data.expiresIn - 3600, 1800) * 1000;
                    if (refreshIn > 0) {
                        setTimeout(async () => {
                            await refreshToken();
                            scheduleTokenRefresh();
                        }, refreshIn);
                    }
                }
            } catch (err) { }
        }
        scheduleTokenRefresh();

        async function loadOrders() {
            try {
                const res = await fetchWithAuth(API_URL);
                const orders = await res.json();

                // Store globally for filtering
                allOrders = orders;

                // Render with current filter
                filterByStatus(currentFilter);

            } catch (err) {
                console.error(err);
                document.getElementById('ordersList').innerHTML = '<p style="color: var(--color-red);">Failed to load orders.</p>';
            }
        }

        window.updateStatus = async (id, newStatus) => {
            try {
                const res = await fetchWithAuth(`${API_URL}/${id}/status`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: newStatus })
                });

                if (res.ok) {
                    // Status updated successfully
                } else {
                    const data = await res.json();
                    alert('Update failed: ' + data.message);
                    loadOrders(); // Reload to reset select value
                }
            } catch (err) {
                console.error(err);
                alert('Update failed');
                loadOrders();
            }
        };

        window.toggleDetails = (id) => {
            const el = document.getElementById(`details-${id}`);
            if (el.style.display === 'block') {
                el.style.display = 'none';
            } else {
                el.style.display = 'block';
            }
        };

        document.getElementById('logoutBtn').addEventListener('click', () => {
            localStorage.removeItem('adminToken');
            window.location.href = 'login.html';
        });

        // Store all orders for filtering
        let allOrders = [];
        let currentFilter = 'all';

        window.filterByStatus = function (status) {
            currentFilter = status;

            // Update tab styles
            document.querySelectorAll('.status-tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.dataset.status === status) {
                    tab.classList.add('active');
                }
            });

            // Filter and display orders
            const filteredOrders = status === 'all'
                ? allOrders
                : allOrders.filter(o => o.status === status);

            renderOrders(filteredOrders);
        };

        function renderOrders(orders) {
            const container = document.getElementById('ordersList');

            if (orders.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--color-gray);">該当する注文はありません。</p>';
                return;
            }

            const statusMap = {
                'Pending': '保留中',
                'Processing': '処理中',
                'Shipped': '発送済み',
                'Delivered': '配達完了',
                'Cancelled': 'キャンセル'
            };

            container.innerHTML = orders.map(order => {
                const statusClass = `status-${order.status.toLowerCase()}`;
                const date = new Date(order.createdAt).toLocaleDateString();
                const statusLabel = statusMap[order.status] || order.status;

                return `
                    <div class="order-card" data-status="${order.status}">
                        <div class="order-header" onclick="toggleDetails('${order._id}')">
                            <div>
                                <strong>注文番号: #${order.orderId || order._id.slice(-6).toUpperCase()}</strong>
                                <div style="color: var(--color-white); font-size: 0.9rem; margin: 4px 0;">${order.customer.email}</div>
                                <span style="font-size: 0.85rem; color: var(--color-gray);">${date}</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 15px;">
                                <span>¥${order.totalAmount.toLocaleString()}</span>
                                <span class="status-badge ${statusClass}">${statusLabel}</span>
                                <span style="font-size: 12px;">▼</span>
                            </div>
                        </div>
                        <div id="details-${order._id}" class="order-details">
                            <div class="detail-grid">
                                <div>
                                    <h4 style="margin-bottom: 10px; color: var(--color-gray);">顧客情報</h4>
                                    <p>名前: ${order.customer.firstName} ${order.customer.lastName}</p>
                                    <p>Email: ${order.customer.email}</p>
                                    <p>電話番号: ${order.customer.phone || 'N/A'}</p>
                                    <p>住所: ${order.customer.address} ${order.customer.apartment ? order.customer.apartment : ''}, ${order.customer.city}, ${order.customer.state || ''} ${order.customer.zipCode}, ${order.customer.country || 'USA'}</p>
                                </div>
                                <div>
                                    <h4 style="margin-bottom: 10px; color: var(--color-gray);">ステータス変更</h4>
                                     <select class="status-select" onchange="updateStatus('${order._id}', this.value)">
                                        <option value="Pending" ${order.status === 'Pending' ? 'selected' : ''}>保留中</option>
                                        <option value="Processing" ${order.status === 'Processing' ? 'selected' : ''}>処理中</option>
                                        <option value="Shipped" ${order.status === 'Shipped' ? 'selected' : ''}>発送済み</option>
                                        <option value="Delivered" ${order.status === 'Delivered' ? 'selected' : ''}>配達完了</option>
                                        <option value="Cancelled" ${order.status === 'Cancelled' ? 'selected' : ''}>キャンセル</option>
                                    </select>
                                </div>
                            </div>
                            
                            <h4 style="margin-bottom: 10px; color: var(--color-gray);">注文詳細</h4>
                            <div class="product-summary">
                                ${order.items.map(item => `
                                    <div class="order-item">
                                        <img src="${item.image || '/assets/placeholder.png'}" alt="${item.name}" class="order-item-image" onerror="this.src='/assets/logo.png'">
                                        <div class="order-item-details">
                                            <div class="order-item-name">${item.name}</div>
                                            <div class="order-item-meta">
                                                ${item.size ? `サイズ: ${item.size}` : ''} | 数量: ${item.quantity}
                                            </div>
                                        </div>
                                        <span class="order-item-price">¥${(item.price * item.quantity).toLocaleString()}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        loadOrders();
    </script>
</body>

</html>